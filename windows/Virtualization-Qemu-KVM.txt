QEMU
QEMU is a userland type 2 hypervisor for performing hardware virtualization (not to be confused with hardware-assisted virtualization), such as disk, network, VGA, PCI, USB, serial/parallel ports, etc. It is flexible in that it can emulate CPUs via dynamic binary translation (DBT) allowing code written for a given processor to be executed on another (i.e ARM on x86, or PPC on ARM). Though QEMU can run on its own and emulate all of the virtual machine’s resources, as all the emulation is performed in software it is extremely slow.

KVM
KVM is a Linux kernel module. It is a type 1 hypervisor that is a full virtualization solution for Linux on x86 hardware containing virtualization extensions (Intel VT or AMD-V). But what is full virtualization, you may ask? When a CPU is emulated (vCPU) by the hypervisor, the hypervisor has to translate the instructions meant for the vCPU to the physical CPU. As you can imagine this has a massive performance impact. To overcome this, modern processors support virtualization extensions, such as Intel VT-x and AMD-V. These technologies provide the ability for a slice of the physical CPU to be directly mapped to the vCPU. Therefore the instructions meant for the vCPU can be directly executed on the physical CPU slice.

Summary
QEMU can run independently, but due to the emulation being performed entirely in software it is extremely slow. To overcome this, QEMU allows you to use KVM as an accelerator so that the physical CPU virtualization extensions can be used. So to conclude: QEMU is a type 2 hypervisor that runs within user space and performs virtual hardware emulation, whereas KVM is a type 1 hypervisor that runs in kernel space, that allows a user space program access to the hardware virtualization features of various processors

Short overview of Image-Files formats
raw - is the default format. Allows flexible converting. Takes only used side on host, but only if used ext4 and (ext3?). This is called spare file or spare image
qed - is enhanced disc format for faster access (since QEMU 0.14). It supports overlay and sparse images. Overlay means that on create you can assign allready existing image as base and only differences will be written to the overlay image (Beware: base image has to stay unchanged!). Its also faster than qcow2
qcow2 - is most featured format in QEMU and is meant to replace qcow. This format support sparse images independent of underlying fs capabilities. It supports multiple VM-snapshots, encryption (AES) and compression.
qcowis - an old QEMU format. Images in qcow are sparse and like qcow2 independent of underlying file system capabilities.
vmdk - is standard format for VMware Workstation. Overlay function is similar to qcow2.
vdi - is standard format for Virtual Box.
parallels - is a standard image tp of virtualization solutions of Paralles Inc.
vpc - standard image format for Microsoft Virtual PC


[[Step 1]]: Check Virtualization Support in Ubuntu

Before installing KVM on Ubuntu, we are first going to verify if the hardware supports KVM. A minimum requirement for installing KVM is the availability of CPU virtualization extensions such as AMD-V and Intel-VT.

To check whether the Ubuntu system supports virtualization, run the following command. An outcome greater than 0 implies that virtualization is supported.
$ egrep -c '(vmx|svm)' /proc/cpuinfo

To check if your system supports KVM virtualization execute the command:
$ sudo kvm-ok

If the “kvm-ok” utility is not present on your server, install it by running the apt command:
$ sudo apt install cpu-checker

[[Step 2]]: Install KVM on Ubuntu 20.04 LTS

With the confirmation that our system can support KVM virtualization, we are going to install KVM, To install KVM, virt-manager, bridge-utils and other dependencies, run the command:
$ sudo apt install -y qemu qemu-kvm libvirt-daemon libvirt-clients bridge-utils virt-manager virt-viewer virtinst

A little explanation of the above packages.
- qemu package (quick emulator) is an application that allows you to perform hardware virtualization.
- qemu-kvm package is the main KVM package.
- libvritd-daemon is the virtualization daemon.
- libvirt-client is a package tht provides the virsh utility used for interacting with virtual machines.
- bridge-utils package helps you create a bridge connection to allow other users to access a virtual machine other than the host system.
- virt-manager is an application for managing virtual machines through a graphical user interface.
- virt-viewer is a utility that displays the graphical view for the virtual machine.
- virt-install is a utility that helps you to create virtual machines and install OS on those virtual machines from command line.
- virtinst is a set of command-line utilities for provisioning and modifying virtual machines.

Before proceeding further, we need to confirm that the virtualization daemon – libvritd-daemon – is running. To do so, execute the command.
$ sudo systemctl status libvirtd

You can enable it to start on boot by running:
$ sudo systemctl enable --now libvirtd

[[Step 3]]: Authorize Users to run Virtual Machines

Only members of the libvirt and kvm user groups can run virtual machines. Add a user to the libvirt & kvm group by typing:
$ sudo usermod -aG libvirt ${USER}
$ sudo usermod -aG kvm ${USER}

Reload updated group membership info as follows. Upon asked for a password, enter your login password.
$ exec su -l $USER

[[Step 4]]: Verify the Installation

To check if the KVM modules are loaded, run the command:
$ lsmod | grep -i kvm

Confirm the installation was successful by using the virsh command:
$ sudo virsh list --all
$ sudo virsh net-list
$ sudo virsh net-info default
$ sudo virsh dominfo <vm>
$ sudo virsh domifaddr <vm>

To create a local virtual bridge network and interface for the kvm:
$ brctl addbr <virbr0>
$ brctl stp <virbr0> on
$ brctl addif <virbr0> <vnet0>
$ brctl show
$ brctl showmacs <virbr0>
$ brctl showstp <virbr0>

To start or power on the virtual machine, run:
$ sudo virsh start <vm>

To shut down a virtual machine use the syntax:
$ sudo virsh shutdown <vm>

To reboot the machine, run the command:
$ sudo virsh reboot <vm>

To destroy or forcefully power off virtual machine, run:
$ sudo virsh destroy <vm>

To delete the virtual machine along with its associated storage file, run:
$ sudo virsh undefine --domain <vm> --remove-all-storage

To connect to the guest console, use the command:
$ sudo virsh console <vm>
